<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title><title><no title></title></title>
  <meta http-equiv="content-type" content="text/html; charset=None">
  <link rel="stylesheet" href="pygments.css" type="text/css">
</head>
<body>
<h2><title><no title></title></h2>

<div class="highlight"><pre><span></span><span class="c1">// Initial inspiration was from: http://www.bytemuse.com/post/k-means-clustering-visualization/</span>
<span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// Number of points to be used in the K-Means Visualization</span>
  <span class="kd">var</span> <span class="nx">NUM_POINTS</span> <span class="o">=</span> <span class="mf">500</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">$numClusters</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#num-clusters&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">numClusters</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$numClusters</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="mf">10</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">$numCentroids</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#num-centroids&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">numCentroids</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$numClusters</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="mf">10</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">$rangeSlider</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#range-slider&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">$meanSquareValue</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.mean-square-value&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#kmeans-vis&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">height</span> <span class="o">=</span> <span class="nx">width</span><span class="p">;</span>

  <span class="c1">// Create SVG for d3</span>
  <span class="kd">var</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;#kmeans-vis&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;svg&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="nx">width</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>

  <span class="nx">pointsGroup</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">centroidsGroup</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;centroids&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">voronoiGroup</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;g&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;voronoi&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">triangle</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">symbol</span><span class="p">().</span><span class="nx">type</span><span class="p">(</span><span class="s1">&#39;triangle-up&#39;</span><span class="p">).</span><span class="nx">size</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mf">200</span><span class="p">;</span> <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">category10</span><span class="p">();</span>

  <span class="c1">// Array of (x, y) points that will be classified</span>
  <span class="kd">var</span> <span class="nx">points</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="c1">// Array of (x, y) centroids</span>
  <span class="kd">var</span> <span class="nx">centroids</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">centroidBins</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="c1">// Initial randomness. This is what the slider is set to.</span>
  <span class="c1">// 0 means data is very clustered, 100 means completely random</span>
  <span class="kd">var</span> <span class="nx">randomness</span> <span class="o">=</span> <span class="mf">25</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">$step</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.step&#39;</span><span class="p">);</span>

  <span class="nx">rangeSlider</span><span class="p">(</span><span class="nx">$rangeSlider</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="p">{</span>
    <span class="nx">value</span><span class="o">:</span> <span class="nx">randomness</span><span class="p">,</span>
    <span class="nx">drag</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Update the randomness after the user drags the slider</span>
      <span class="c1">// and reset the points to be clustered</span>
      <span class="nx">randomness</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
      <span class="nx">resetPoints</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// Resets the text on the centroid button</span>
  <span class="kd">function</span> <span class="nx">resetCentroidUpdateText</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$step</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;find&#39;</span><span class="p">);</span>
    <span class="nx">$step</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;Find closest centroid&#39;</span><span class="p">);</span>

    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.active&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.closest&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Every time the step button is clicked, we alternate between finding the closest</span>
  <span class="c1">// centroid and updating the centroid</span>
  <span class="nx">$step</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$step</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;find&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">findClosestCentroid</span><span class="p">();</span>
      <span class="nx">findClosestCentroidAnimation</span><span class="p">();</span>
      <span class="nx">$step</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;find&#39;</span><span class="p">);</span>
      <span class="nx">$step</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;Update centroid&#39;</span><span class="p">);</span>

      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.active&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.update&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">updateCentroid</span><span class="p">();</span>
      <span class="nx">updateCentroidAnimation</span><span class="p">();</span>
      <span class="nx">resetCentroidUpdateText</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.closest&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.closest&#39;</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">$step</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.update&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.update&#39;</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">$step</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.new-points&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">resetPoints</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">$numClusters</span><span class="p">.</span><span class="nx">blur</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">numClustersNew</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$numClusters</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="mf">10</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">numClustersNew</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">numClustersNew</span> <span class="o">!=</span> <span class="nx">numClusters</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resetPoints</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">$numCentroids</span><span class="p">.</span><span class="nx">blur</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">numCentroidsNew</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$numCentroids</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="mf">10</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">numCentroidsNew</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">numCentroidsNew</span> <span class="o">!=</span> <span class="nx">numCentroids</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">generateClusters</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.new-centroids&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">generateClusters</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">$numClusters</span><span class="p">.</span><span class="nx">blur</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">numClustersNew</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$numClusters</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="mf">10</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">numClustersNew</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">numClustersNew</span> <span class="o">!=</span> <span class="nx">numClusters</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resetPoints</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">$numCentroids</span><span class="p">.</span><span class="nx">blur</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">numCentroidsNew</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$numCentroids</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="mf">10</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">numCentroidsNew</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">numCentroidsNew</span> <span class="o">!=</span> <span class="nx">numCentroids</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">generateClusters</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">uncolorPoints</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">pointsGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
    <span class="nx">pointsGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;circle&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">points</span><span class="p">).</span><span class="nx">enter</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;circle&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cx&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
      <span class="p">}).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cy&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mf">1</span><span class="p">];</span>
      <span class="p">}).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="mf">3</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">resetPoints</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">resetCentroidUpdateText</span><span class="p">();</span>
    <span class="nx">points</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="c1">// Arbitrarily chosen variance and percentageClusteredPoints</span>
    <span class="c1">// There is no signficance behind the constants except that they looked good</span>
    <span class="c1">// with the slider.</span>
    <span class="kd">var</span> <span class="nx">variance</span> <span class="o">=</span> <span class="nx">randomness</span> <span class="o">/</span> <span class="mf">2</span> <span class="o">+</span> <span class="mf">5</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">percentageClusteredPoints</span> <span class="o">=</span> <span class="p">(</span><span class="mf">100</span> <span class="o">-</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="nx">randomness</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100</span><span class="p">;</span>

    <span class="nx">numClusters</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$numClusters</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="mf">10</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">numClusters</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Creates a normal distribution with mean randomCenter(parameter)</span>
      <span class="c1">// and variance</span>
      <span class="kd">var</span> <span class="nx">xNorm</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">random</span><span class="p">.</span><span class="nx">normal</span><span class="p">(</span><span class="nx">randomCenter</span><span class="p">(</span><span class="nx">width</span><span class="p">),</span> <span class="nx">variance</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">yNorm</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">random</span><span class="p">.</span><span class="nx">normal</span><span class="p">(</span><span class="nx">randomCenter</span><span class="p">(</span><span class="nx">height</span><span class="p">),</span> <span class="nx">variance</span><span class="p">);</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">percentageClusteredPoints</span> <span class="o">*</span> <span class="nx">NUM_POINTS</span> <span class="o">/</span> <span class="nx">numClusters</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">points</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">normalPt</span><span class="p">(</span><span class="nx">xNorm</span><span class="p">),</span> <span class="nx">normalPt</span><span class="p">(</span><span class="nx">yNorm</span><span class="p">)]);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Scatter the remaining points randomly</span>
    <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">NUM_POINTS</span> <span class="o">-</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">points</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">randomCenter</span><span class="p">(</span><span class="nx">width</span><span class="p">),</span> <span class="nx">randomCenter</span><span class="p">(</span><span class="nx">height</span><span class="p">)]);</span>
    <span class="p">}</span>

    <span class="nx">uncolorPoints</span><span class="p">();</span>
    <span class="nx">resetCentroidUpdateText</span><span class="p">();</span>
    <span class="nx">voronoiGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>

    <span class="nx">$meanSquareValue</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;not yet calculated&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Randomly generates the clusters and initializes the d3 animation</span>
  <span class="kd">function</span> <span class="nx">generateClusters</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">centroids</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">numCentroids</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$numCentroids</span><span class="p">.</span><span class="nx">val</span><span class="p">(),</span> <span class="mf">10</span><span class="p">);</span>
    <span class="nx">uncolorPoints</span><span class="p">();</span>
    <span class="nx">resetCentroidUpdateText</span><span class="p">();</span>

    <span class="c1">// Generate completely random centroids</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">numCentroids</span><span class="p">;</span> <span class="nx">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">randomX</span> <span class="o">=</span> <span class="nx">randomCenter</span><span class="p">(</span><span class="nx">width</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">randomY</span> <span class="o">=</span> <span class="nx">randomCenter</span><span class="p">(</span><span class="nx">height</span><span class="p">);</span>
      <span class="nx">centroids</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">randomX</span><span class="p">,</span> <span class="nx">randomY</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="c1">// Render initial centroid display</span>
    <span class="nx">centroidsGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
    <span class="nx">voronoiGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>

    <span class="nx">centroidsGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">centroids</span><span class="p">).</span><span class="nx">enter</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="nx">triangle</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">ndx</span><span class="p">){</span> <span class="k">return</span> <span class="nx">colors</span><span class="p">(</span><span class="nx">ndx</span><span class="p">);</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s1">&#39;stroke&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s1">&#39;stroke-width&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span> <span class="k">return</span> <span class="s1">&#39;translate(&#39;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span> <span class="p">});</span>

    <span class="nx">$meanSquareValue</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;not yet calculated&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// For each point, we find the centroid it is the closest to.</span>
  <span class="kd">function</span> <span class="nx">findClosestCentroid</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">centroidBins</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">numCentroids</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">centroidBins</span><span class="p">.</span><span class="nx">push</span><span class="p">([]);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">point</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">minDist</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">minIndex</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">centroids</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">centroid</span> <span class="o">=</span> <span class="nx">centroids</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">distance</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">centroid</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">d</span> <span class="o">&lt;</span> <span class="nx">minDist</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">minDist</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
          <span class="nx">minIndex</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">centroidBins</span><span class="p">[</span><span class="nx">minIndex</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">point</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">meanSquaredDistance</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">centroidBins</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bin</span> <span class="o">=</span> <span class="nx">centroidBins</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">bin</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dist</span> <span class="o">=</span> <span class="nx">distance</span><span class="p">(</span><span class="nx">centroids</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">bin</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
        <span class="nx">meanSquaredDistance</span> <span class="o">+=</span> <span class="nx">dist</span> <span class="o">*</span> <span class="nx">dist</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">meanSquaredDistance</span> <span class="o">/=</span> <span class="nx">NUM_POINTS</span><span class="p">;</span>
    <span class="nx">$meanSquareValue</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">meanSquaredDistance</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">findClosestCentroidAnimation</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// TODO: This is terribly inefficient, fix later</span>
    <span class="c1">// Color the points according to the centroid to which they belong</span>
    <span class="nx">pointsGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">ndx</span><span class="p">){</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">centroidBins</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">centroidBins</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mf">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">colors</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">});</span>

    <span class="c1">// Render voronoi</span>
    <span class="nx">voronoiGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>

    <span class="c1">// Comment these lines out to get rid of Voronoi</span>
    <span class="nx">voronoiGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">voronoi</span><span class="p">(</span><span class="nx">centroids</span><span class="p">))</span>
      <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s1">&#39;fill&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">ndx</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">colors</span><span class="p">(</span><span class="nx">ndx</span><span class="p">);</span>
      <span class="p">}).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;M&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;Z&#39;</span><span class="p">;</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Once the points have been assigned to the centroids, updates the</span>
  <span class="c1">// centroid to be the mean of all points assigned to it</span>
  <span class="kd">function</span> <span class="nx">updateCentroid</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">meanSquaredDistance</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span>
    <span class="c1">// Find new centroids</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">centroidBins</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bin</span> <span class="o">=</span> <span class="nx">centroidBins</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">newCentroid</span> <span class="o">=</span> <span class="nx">avgXY</span><span class="p">(</span><span class="nx">bin</span><span class="p">);</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">bin</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dist</span> <span class="o">=</span> <span class="nx">distance</span><span class="p">(</span><span class="nx">newCentroid</span><span class="p">,</span> <span class="nx">bin</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
        <span class="nx">meanSquaredDistance</span> <span class="o">+=</span> <span class="nx">dist</span> <span class="o">*</span> <span class="nx">dist</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// If there are no points in the bin, newCentroid may be NaN</span>
      <span class="c1">// In this case, we don&#39;t update the centroid location</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">newCentroid</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">newCentroid</span><span class="p">[</span><span class="mf">1</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">centroids</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newCentroid</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">meanSquaredDistance</span> <span class="o">/=</span> <span class="nx">NUM_POINTS</span><span class="p">;</span>
    <span class="nx">$meanSquareValue</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">meanSquaredDistance</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateCentroidAnimation</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">centroidsGroup</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">centroids</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span> <span class="k">return</span> <span class="s1">&#39;translate(&#39;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Initial generation of clusters</span>
  <span class="nx">generateClusters</span><span class="p">();</span>

  <span class="c1">// Helper functions</span>

  <span class="c1">// Generate centers for dist centers and centroids</span>
  <span class="kd">function</span> <span class="nx">randomCenter</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">n</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="c1">// Euclidean distance between points a and b</span>
  <span class="kd">function</span> <span class="nx">distance</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">b</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="mf">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">b</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span> <span class="mf">2</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="c1">// Finds the average x value and average y value of all the points in arr</span>
  <span class="kd">function</span> <span class="nx">avgXY</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">avgX</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sum</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span> <span class="p">})</span> <span class="o">/</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">avgY</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sum</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mf">1</span><span class="p">];</span> <span class="p">})</span> <span class="o">/</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">avgX</span><span class="p">,</span> <span class="nx">avgY</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="c1">// Given a function normalFn, uses it to generate a value. If the value</span>
  <span class="c1">// is not within the range (0, width), continues to do so.</span>
  <span class="kd">function</span> <span class="nx">normalPt</span><span class="p">(</span><span class="nx">normalFn</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">normalFn</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">&gt;</span> <span class="mf">0</span> <span class="o">&amp;&amp;</span> <span class="nx">val</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">normalPt</span><span class="p">(</span><span class="nx">normalFn</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</body>
</html>
